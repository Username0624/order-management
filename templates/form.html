<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®å…§å®¹ | è¨‚å–®ç®¡ç†ç³»çµ±</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8uR2gII9oMvW14jWc//Y4/l86iMvW14jWc//Y4/l86iM/8U8/51L6I6w1YtJ5P5w5/2F/1L6W1P5w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> 
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid container-xl">
            <h2 class="navbar-brand mb-0 text-truncate" id="formTitle">è¡¨å–®</h2>
            
            <div class="d-flex align-items-center">
                <button onclick="location.href='{{ url_for('dashboard_page') }}'" class="btn btn-outline-light me-2">
                    <i class="fas fa-arrow-left me-1"></i> å› Dashboard
                </button>
                <button onclick="logout()" class="btn btn-outline-light">
                    <i class="fas fa-sign-out-alt me-1"></i> ç™»å‡º
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container-xl mt-4 mb-5">
        
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title text-primary"><i class="fas fa-file-alt me-2"></i> è¡¨å–®ç°¡ä»‹</h5>
                        
                        <p class="mb-2" id="formDescription" style="font-size:1rem; color:#444;">ï¼ˆç„¡ç°¡ä»‹ï¼‰</p>

                        <button id="editDescBtn" class="btn btn-sm btn-outline-secondary" style="display:none;">
                            <i class="fas fa-edit me-1"></i> ç·¨è¼¯ç°¡ä»‹
                        </button>
                        
                        <div id="descEditArea" class="mt-3" style="display:none;">
                            <textarea id="descInput" class="form-control mb-2" rows="4" placeholder="è¼¸å…¥æ–°çš„è¡¨å–®ç°¡ä»‹"></textarea>
                            <button id="saveDescBtn" class="btn btn-primary btn-sm me-2"><i class="fas fa-save me-1"></i> å„²å­˜ç°¡ä»‹</button>
                            <button id="cancelDescBtn" class="btn btn-outline-danger btn-sm"><i class="fas fa-times me-1"></i> å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title text-success"><i class="fas fa-user-tag me-2"></i> è§’è‰²èˆ‡ç¸½çµ</h5>
                        <p id="roleInfo" class="mb-2 text-muted"></p>
                        <div id="summaryArea"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i> è¨‚å–®æ˜ç´°</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0" id="table">
                        <thead class="table-primary" id="thead"></thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="addArea" class="card shadow-sm" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i> æ–°å¢è¨‚å–®é …ç›®</h5>
            </div>
            <div class="card-body">
                <div id="addInputs" class="row row-cols-1 row-cols-md-3 g-3">
                    </div>
                <hr class="my-4">
                <button id="addBtn" class="btn btn-success me-2"><i class="fas fa-check me-1"></i> ç¢ºèªæ–°å¢</button>
                <button id="clearBtn" class="btn btn-danger"><i class="fas fa-trash-alt me-1"></i> æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
            </div>
        </div>

    </div>

<script src="{{ url_for('static', filename='api.js') }}"></script>
<script>
// ----------------------------------------------------------------------
// å…¨åŸŸè®Šæ•¸å’Œåˆå§‹åŒ–
// ----------------------------------------------------------------------

// ç¢ºä¿å‡½å¼å­˜åœ¨ï¼Œä»¥ä¾¿ Navbar ä¸­çš„æŒ‰éˆ•å¯ä»¥ä½¿ç”¨
function logout(){
    if(confirm("ç¢ºå®šç™»å‡ºå—ï¼Ÿ")){
        localStorage.removeItem("form_id");
        localStorage.removeItem("form_role");
        localStorage.removeItem("user_id");
        localStorage.removeItem("username");
        localStorage.removeItem("email"); // ç¢ºä¿æ¸…é™¤ email
        location.href = "/login";
    }
}

const form_id = localStorage.getItem("form_id");
const user_id = localStorage.getItem("user_id");
const user_email = localStorage.getItem("email"); // è®€å–ç•¶å‰ç™»å…¥çš„ email
let currentForm = null;
let isOwner = false;

// ----------------------------------------------------------------------
// è¼‰å…¥èˆ‡åˆå§‹åŒ–
// ----------------------------------------------------------------------
async function build(){
    const res = await apiGetForm(form_id, user_id);
    if(!res.success){
        alert(res.message || "è®€å–å¤±æ•—");
        location.href = "{{ url_for('dashboard_page') }}";
        return;
    }

    currentForm = res.form;
    isOwner = res.is_owner;

    // 1. è™•ç†æ¨™é¡Œèˆ‡ç°¡ä»‹
    document.getElementById("formTitle").innerText = currentForm.title || "è¡¨å–®";
    document.getElementById("formDescription").innerText =
        currentForm.description ? currentForm.description : "ï¼ˆç„¡ç°¡ä»‹ï¼‰";

    const editBtn = document.getElementById("editDescBtn");
    const descEditArea = document.getElementById("descEditArea");
    if(isOwner){
        editBtn.style.display = "inline-block";
        editBtn.onclick = () => {
            document.getElementById("descInput").value = currentForm.description || "";
            descEditArea.style.display = "block";
            editBtn.style.display = "none";
        };
    } else {
        editBtn.style.display = "none";
        descEditArea.style.display = "none";
    }

    // 2. ç°¡ä»‹ç·¨è¼¯é‚è¼¯
    document.getElementById("saveDescBtn").onclick = async () => {
        const newDesc = document.getElementById("descInput").value;
        const r = await apiUpdateFormDescription(form_id, newDesc);
        if(r && r.success){
            alert("ç°¡ä»‹å·²æ›´æ–°");
            descEditArea.style.display = "none";
            build(); // é‡æ–°è¼‰å…¥
        } else {
            alert("æ›´æ–°å¤±æ•—");
        }
    };
    document.getElementById("cancelDescBtn").onclick = () => {
        descEditArea.style.display = "none";
        if(isOwner) editBtn.style.display = "inline-block";
    };

    // 3. é¡¯ç¤ºè§’è‰²è³‡è¨Š
    document.getElementById("roleInfo").innerText =
        isOwner ? "æ‚¨æ˜¯è³£å®¶ï¼ˆå¯ç·¨è¼¯ï¼‰" : "æ‚¨æ˜¯è²·å®¶ï¼ˆåƒ…æª¢è¦–æ‚¨è‡ªå·±çš„è¨‚å–®ï¼‰";
    
    // 4. æ¸²æŸ“æ ¸å¿ƒæ•¸æ“š
    renderStructure(currentForm.fields, isOwner);
    renderRows(currentForm.rows, isOwner); // åŒ…å«æ¬Šé™éæ¿¾é‚è¼¯
    renderSummary(res.summary_by_buyer);

    // 5. è³£å®¶å°ˆå±¬åŠŸèƒ½
    if(isOwner){
        document.getElementById("addArea").style.display = "block"; // é¡¯ç¤ºæ–°å¢å€
        const rb = await apiRecentBuyers(form_id);
        window.recentBuyers = rb.recent_buyers || [];
        buildBuyerAutocomplete();
    } else {
        document.getElementById("addArea").style.display = "none";
    }
}

// ----------------------------------------------------------------------
// æ¸²æŸ“åŠŸèƒ½
// ----------------------------------------------------------------------

function renderSummary(summary){
    const area = document.getElementById("summaryArea");
    area.innerHTML = `<h6>ç¸½é‡‘é¡æ¦‚è¦½ï¼š</h6>`;
    let total = 0;
    for(const name in summary){
        total += summary[name];
        area.innerHTML += `<div class="text-sm">
            <i class="fas fa-tag me-1 text-success"></i> <strong>${name}</strong>: 
            <span class="fw-bold text-danger">${summary[name].toFixed(2)}</span> å…ƒ
        </div>`;
    }
    area.innerHTML = `<p class="fw-bold mb-1">æ‰€æœ‰è²·å®¶ç¸½è¨ˆ: <span class="text-primary">${total.toFixed(2)}</span> å…ƒ</p>` + area.innerHTML;
}

function renderStructure(fields, owner){
    const thead = document.getElementById("thead");
    const addInputs = document.getElementById("addInputs");
    thead.innerHTML = ""; addInputs.innerHTML = "";

    const cols = [
        {k:"buyer_name", label:"è²·å®¶"},
        {k:"buyer_email", label:"è²·å®¶ Email"},
        {k:"item_name", label:"ç‰©å“åç¨±"},
        {k:"item_qty", label:"æ•¸é‡"},
        {k:"item_price", label:"å–®åƒ¹"},
        {k:"item_total", label:"é ˆåŒ¯æ¬¾é‡‘é¡"}
    ];
    if(fields.remittance) cols.push({k:"remittance", label:"å·²åŒ¯æ¬¾"});
    if(fields.shipped) cols.push({k:"shipped", label:"å‡ºè²¨æ—¥æœŸ"});
    if(fields.shipping_fee) cols.push({k:"shipping_fee", label: fields.merge_shipping ? "é‹è²»" : "é‹è²»(éœ€äºŒè£œ)"});
    if(fields.buyer_social && owner) cols.push({k:"buyer_social", label:"è²·å®¶ç¤¾ç¾¤"});
    cols.push({k:"actions", label:"æ“ä½œ"});

    // è¡¨æ ¼æ¨™é ­
    let tr = "<tr>";
    cols.forEach(c=> tr += `<th>${c.label}</th>`);
    tr += "</tr>";
    thead.innerHTML = tr;

    // æ–°å¢è¼¸å…¥å€å¡Š (ä½¿ç”¨ Bootstrap Grid)
    if(owner){
        addInputs.innerHTML = `
            <div class="col"><label class="form-label">è²·å®¶</label><input id="in_buyer_name" class="form-control"></div>
            <div class="col"><label class="form-label">è²·å®¶ Email</label><input id="in_buyer_email" class="form-control" list="recentList"><datalist id="recentList"></datalist></div>
            <div class="col"><label class="form-label">ç‰©å“åç¨±</label><input id="in_item_name" class="form-control"></div>
            <div class="col"><label class="form-label">æ•¸é‡</label><input id="in_item_qty" type="number" class="form-control" value="1"></div>
            <div class="col"><label class="form-label">å–®åƒ¹</label><input id="in_item_price" type="number" class="form-control" value="0"></div>
            
            ${fields.shipping_fee ? `
            <div class="col"><label class="form-label">é‹è²»</label><input id="in_shipping_fee" type="number" class="form-control" value="0"></div>` : ''}

            ${fields.buyer_social ? `
            <div class="col"><label class="form-label">è²·å®¶ç¤¾ç¾¤</label><input id="in_buyer_social" class="form-control"></div>` : ''}
            
            <div class="col-12 mt-3">
                ${fields.remittance ? `<div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="in_remittance">
                    <label class="form-check-label" for="in_remittance">å·²åŒ¯æ¬¾</label>
                </div>` : ''}
                
                ${fields.shipped ? `<div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="in_shipped">
                    <label class="form-check-label" for="in_shipped">å·²å‡ºè²¨</label>
                </div>
                <input type="date" id="in_shipped_date" class="form-control form-control-sm d-inline-block w-auto" style="display:none; margin-left:10px;">` : ''}
            </div>
        `;

        // å‡ºè²¨æ—¥æœŸé‚è¼¯
        setTimeout(()=>{
            const sh = document.getElementById("in_shipped");
            if(sh) sh.addEventListener("change", ()=>{
                const dd = document.getElementById("in_shipped_date");
                if(sh.checked){
                    dd.style.display = "inline-block";
                    dd.value = new Date().toISOString().slice(0,10);
                } else {
                    dd.style.display="none";
                    dd.value = '';
                }
            });
        },100);
    } 
}

function renderRows(rows, owner){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    
    // ğŸŒŸ ä¿®æ­£é»ï¼šç§»é™¤å‰ç«¯çš„é‡è¤‡ç¯©é¸é‚è¼¯ 
    // ç”±æ–¼å¾Œç«¯ API å·²ç¶“ç‚º Viewer (é Owner) ç¯©é¸éè¨‚å–®ï¼Œé€™è£¡ç›´æ¥ä½¿ç”¨å›å‚³çš„ rowsã€‚
    const displayRows = rows; // ä»¥å‰çš„å¯«æ³•: owner ? rows : rows.filter(r => r.buyer_email === user_email);

    if (displayRows.length === 0) {
        // ç¢ºä¿åœ¨æ²’æœ‰è¨‚å–®æ™‚ï¼Œè¡¨æ ¼è¡¨é ­å·²å­˜åœ¨ï¼Œä»¥ä¾¿è¨ˆç®— colspan
        const head = document.getElementById("thead").querySelector('tr');
        const colspanCount = head ? head.children.length : 10; 
        tbody.innerHTML = `<tr><td colspan="${colspanCount}" class="text-center text-muted py-3">ç›®å‰æ²’æœ‰è¨‚å–®æ•¸æ“šã€‚</td></tr>`;
        return;
    }

    displayRows.forEach((r, idx)=>{
        const tr = document.createElement("tr");
        const shippedText = r.shipped ? r.shipped : "æœªå‡ºè²¨";
        
        let html = `
            <td>${r.buyer_name||""}</td>
            <td>${r.buyer_email||""}</td>
            <td>${r.item_name||""}</td>
            <td>${r.item_qty ?? ""}</td>
            <td>${r.item_price ?? ""}</td>
            <td><span class="fw-bold text-danger">${(r.item_total ?? 0).toFixed(2)}</span></td>`;
        
        // ä¿®æ­£ã€Œå·²åŒ¯æ¬¾ã€ï¼šæ”¹ç”¨ Unicode ç¬¦è™Ÿ âœ“ å’Œ âœ— 
        if(currentForm.fields.remittance) {
            const symbol = r.remittance ? 
                '<span class="text-success fs-5 fw-bold" title="å·²åŒ¯æ¬¾">âœ“</span>' : 
                '<span class="text-danger fs-5 fw-bold" title="æœªåŒ¯æ¬¾">âœ—</span>';
            html += `<td>${symbol}</td>`;
        }
        
        if(currentForm.fields.shipped) html += `<td>${shippedText}</td>`;
        if(currentForm.fields.shipping_fee) html += `<td>${r.shipping_fee ?? ""}</td>`;
        
        // è²·å®¶ç¤¾ç¾¤åªåœ¨ Owner æ¨¡å¼ä¸‹é¡¯ç¤º
        if(currentForm.fields.buyer_social && owner) html += `<td>${r.buyer_social||""}</td>`;
        
        // æ“ä½œæŒ‰éˆ•
        if (owner) {
             // ä¿ç•™ Font Awesome åœ–ç¤ºç”¨æ–¼æ“ä½œæŒ‰éˆ•
             html += `<td>
                 <button class="editBtn btn btn-sm btn-outline-primary me-1"><i class="fas fa-pen"></i></button> 
                 <button class="deleteBtn btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
               </td>`;
        } else {
             html += `<td>â€”</td>`;
        }
        
        tr.innerHTML = html;
        tr.dataset.index = idx;
        tbody.appendChild(tr);
    });

    // ç¶å®šç·¨è¼¯/åˆªé™¤äº‹ä»¶
    if(owner){
        document.querySelectorAll(".editBtn").forEach(btn=>{
            btn.addEventListener("click", (e)=>{
                const tr = e.target.closest("tr");
                startEdit(tr, Number(tr.dataset.index));
            });
        });
        document.querySelectorAll(".deleteBtn").forEach(btn=>{
            btn.addEventListener("click", async (e)=>{
                const tr = e.target.closest("tr");
                const idx = Number(tr.dataset.index);
                if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è¨‚å–®ï¼Ÿ")) return;
                const res = await apiDeleteRow(form_id, user_id, idx);
                if(res.success) build(); else alert("åˆªé™¤å¤±æ•—");
            });
        });
    }
}

function startEdit(tr, index){
    // å„²å­˜åŸå§‹å…§å®¹ï¼Œä»¥ä¾¿å–æ¶ˆæ™‚æ¢å¾©
    const originalHTML = tr.innerHTML;
    const tds = tr.querySelectorAll("td");
    
    // æ›¿æ› TD å…§å®¹ç‚º Input æ¬„ä½
    tds[0].innerHTML = `<input class="form-control form-control-sm" value="${tds[0].innerText}">`;
    tds[1].innerHTML = `<input class="form-control form-control-sm" value="${tds[1].innerText}">`;
    tds[2].innerHTML = `<input class="form-control form-control-sm" value="${tds[2].innerText}">`;
    tds[3].innerHTML = `<input type="number" class="form-control form-control-sm" value="${tds[3].innerText}">`;
    tds[4].innerHTML = `<input type="number" class="form-control form-control-sm" value="${tds[4].innerText}">`;
    tds[5].innerText = ""; // ç¸½é‡‘é¡æ¬„ä½æ¸…ç©ºï¼Œç­‰å¾…è¨ˆç®—

    let col = 6;
    if(currentForm.fields.remittance){
        // ä¿®æ­£ã€Œå·²åŒ¯æ¬¾ã€ç·¨è¼¯ï¼šæª¢æŸ¥ç•¶å‰ TD å…§å®¹æ˜¯å¦ç‚º 'âœ“' (è¡¨ç¤ºå·²åŒ¯æ¬¾)
        const isChecked = tds[col].innerText.includes('âœ“');
        tds[col].innerHTML = `<input type="checkbox" id="edit_remit" ${isChecked ? "checked":""}>`;
        col++;
    }
    if(currentForm.fields.shipped){
        const val = tds[col].innerText === "æœªå‡ºè²¨" ? "" : tds[col].innerText;
        tds[col].innerHTML = `<input type="date" id="edit_shipped" class="form-control form-control-sm" value="${val}">`;
        col++;
    }
    if(currentForm.fields.shipping_fee){
        const shippingFeeValue = currentForm.rows[index].shipping_fee ?? 0;
        tds[col].innerHTML = `<input type="number" id="edit_shipfee" class="form-control form-control-sm" value="${shippingFeeValue}">`;
        col++;
    }
    // è²·å®¶ç¤¾ç¾¤åªåœ¨ Owner æ¨¡å¼ä¸‹å¯ç·¨è¼¯
    if(currentForm.fields.buyer_social && isOwner){
        tds[col].innerHTML = `<input id="edit_social" class="form-control form-control-sm" value="${tds[col].innerText||''}">`;
        col++;
    }

    // æ“ä½œæŒ‰éˆ•æ›¿æ›ç‚ºå„²å­˜/å–æ¶ˆ
    tds[tds.length-1].innerHTML = `
        <button id="saveBtn" class="btn btn-success btn-sm me-1"><i class="fas fa-save"></i> å„²å­˜</button> 
        <button id="cancelBtn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-times"></i> å–æ¶ˆ</button>
    `;

    document.getElementById("saveBtn").addEventListener("click", async ()=>{
        const buyer_name = tds[0].querySelector("input").value;
        const buyer_email = tds[1].querySelector("input").value;
        const item_name = tds[2].querySelector("input").value;
        const item_qty = Number(tds[3].querySelector("input").value || 0);
        const item_price = Number(tds[4].querySelector("input").value || 0);

        let remittance=false, shipped=null, shipping_fee=0, buyer_social=null;
        
        // ç”±æ–¼ Owner æ‰èƒ½ç·¨è¼¯ï¼Œé€™è£¡ä¸éœ€æª¢æŸ¥ isOwner
        let current_col = 6;
        if(currentForm.fields.remittance) {
            remittance = !!document.getElementById("edit_remit").checked;
            current_col++;
        }
        if(currentForm.fields.shipped) {
            shipped = document.getElementById("edit_shipped").value || null;
            current_col++;
        }
        if(currentForm.fields.shipping_fee) {
            shipping_fee = Number(document.getElementById("edit_shipfee").value || 0);
            current_col++;
        }
        if(currentForm.fields.buyer_social) {
            buyer_social = document.getElementById("edit_social").value || null;
            current_col++;
        }

        // âœ… è¨ˆç®— item_total
        let item_total = item_qty * item_price;
        if(currentForm.fields.merge_shipping) item_total += shipping_fee;

        const body = {
            buyer_name, buyer_email, item_name, item_qty, item_price,
            item_total, remittance, shipped, shipping_fee, buyer_social
        };

        const res = await apiUpdateRow(form_id, user_id, index, body);
        if(res.success) build(); else alert("æ›´æ–°å¤±æ•—");
    });

    // å–æ¶ˆæŒ‰éˆ•æ¢å¾©åŸå§‹è¡Œ
    document.getElementById("cancelBtn").addEventListener("click", ()=> build());
}

function buildBuyerAutocomplete(){
    const list = document.getElementById("recentList");
    list.innerHTML = "";
    (window.recentBuyers || []).forEach(e=>{
        const opt = document.createElement("option");
        opt.value = e;
        list.appendChild(opt);
    });
}

// ----------------------------------------------------------------------
// æ–°å¢/æ¸…ç©ºäº‹ä»¶
// ----------------------------------------------------------------------
document.getElementById("addBtn").addEventListener("click", async ()=>{
    const buyer_name = document.getElementById("in_buyer_name").value;
    const buyer_email = document.getElementById("in_buyer_email").value;
    const item_name = document.getElementById("in_item_name").value;
    const item_qty = Number(document.getElementById("in_item_qty").value || 0);
    const item_price = Number(document.getElementById("in_item_price").value || 0);
    
    // ç²å–å¯é¸æ¬„ä½çš„å€¼
    const remittance = document.getElementById("in_remittance") ? !!document.getElementById("in_remittance").checked : false;
    const shipped = document.getElementById("in_shipped") && document.getElementById("in_shipped").checked
                         ? (document.getElementById("in_shipped_date").value || new Date().toISOString().slice(0,10))
                         : null;
    const shipping_fee = document.getElementById("in_shipping_fee")
                             ? Number(document.getElementById("in_shipping_fee").value||0)
                             : 0;
    const buyer_social = document.getElementById("in_buyer_social")
                             ? document.getElementById("in_buyer_social").value || null
                             : null;

    if(!buyer_name || !buyer_email || !item_name || item_qty === 0 || item_price === 0) {
        alert("è«‹ç¢ºä¿è²·å®¶å§“åã€Emailã€ç‰©å“åç¨±ã€æ•¸é‡å’Œå–®åƒ¹éƒ½å·²è¼¸å…¥ï¼");
        return;
    }

    // âœ… è¨ˆç®— item_total
    let item_total = item_qty * item_price;
    if(currentForm.fields.merge_shipping) item_total += shipping_fee;

    const row = { buyer_name, buyer_email, item_name, item_qty, item_price,
                  item_total, remittance, shipped, shipping_fee, buyer_social };

    const res = await apiAddRow(form_id, user_id, row);
    if(res.success) build(); else alert("æ–°å¢å¤±æ•—");
});

document.getElementById("clearBtn").addEventListener("click", async ()=>{
    if(!confirm("ç¢ºå®šæ¸…ç©ºæ­¤è¡¨å–®æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å›å¾©ï¼")) return;
    const res = await apiClearForm(form_id, user_id);
    if(res.success) build(); else alert("æ¸…ç©ºå¤±æ•—");
});

// ----------------------------------------------------------------------
// åˆå§‹åŒ–
// ----------------------------------------------------------------------
build();
</script>
</body>
</html>