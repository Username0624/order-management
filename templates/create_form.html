<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建立新表單</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8uR2gII9oMvW14jWc//Y4/l86iM/8U8/51L6I6w1YtJ5P5w5/2F/1L6W1P5w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> 
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid container-xl">
            <a class="navbar-brand fw-bold" href="{{ url_for('dashboard_page') }}"> 訂單管理系統</a>
            <span class="navbar-text text-white">建立新表單</span>
        </div>
    </nav>
    
    <div class="container-xl mt-4 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                
                <h2 class="mb-4 text-center"> 建立新表單</h2>

                <form id="createForm">
                    
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i> 基本資訊</h4>
                        </div>
                        <div class="card-body">
                            
                            <div class="mb-3">
                                <label for="title" class="form-label fw-bold">表單名稱 <span class="text-danger">*</span></label>
                                <input id="title" class="form-control" type="text" placeholder="例如：團購商品訂單表單 2024/Q3" required>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label fw-bold">表單簡介 (可選)</label>
                                <textarea id="description" class="form-control" rows="3" placeholder="簡短描述表單的用途或注意事項 ex匯款帳號or聯繫方式。"></textarea>
                            </div>

                        </div>
                    </div>
                    
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h4 class="mb-0"><i class="fas fa-list-check me-2"></i> 啟用功能/欄位選項</h4>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">請選擇要在訂單中啟用的可選欄位。（買家姓名、電話、地址、商品清單為必填欄位）</p>

                            <div class="row row-cols-1 row-cols-md-2 g-3">
                                
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="f_remittance">
                                        <label class="form-check-label" for="f_remittance">
                                            匯款狀態
                                            <span class="text-muted small">(checkbox)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="f_shipped">
                                        <label class="form-check-label" for="f_shipped">
                                            出貨狀態
                                            <span class="text-muted small">(出貨時會記錄日期)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="f_shipping_fee">
                                        <label class="form-check-label" for="f_shipping_fee">
                                            運費
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="f_merge_shipping">
                                        <label class="form-check-label" for="f_merge_shipping">
                                            運費是否併入匯款總額計算
                                        </label>
                                    </div>
                                </div>

                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="f_buyer_social">
                                        <label class="form-check-label" for="f_buyer_social">
                                            買家社群帳號連結
                                            <span class="text-danger small">(僅賣家可見)</span>
                                        </label>
                                    </div>
                                </div>
                                
                            </div> 
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" onclick="location.href='{{ url_for('dashboard_page') }}'" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> 取消
                        </button>
                        <button id="createBtn" type="submit" class="btn btn-primary fw-bold">
                            <i class="fas fa-check me-1"></i> 建立表單
                        </button>
                    </div>

                </form> 
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script src="{{ url_for('static', filename='api.js') }}"></script>
    
    <script>
        const owner_id = localStorage.getItem("user_id");
        const owner_email = localStorage.getItem("email");

        document.getElementById("createForm").addEventListener("submit", async (e) => {
            e.preventDefault(); 

            const title = document.getElementById("title").value.trim();
            const description = document.getElementById("description").value.trim();

            if(!title) return alert("請輸入表單名稱");

            const fields = {
                remittance: document.getElementById("f_remittance").checked,
                shipped: document.getElementById("f_shipped").checked,
                shipping_fee: document.getElementById("f_shipping_fee").checked,
                merge_shipping: document.getElementById("f_merge_shipping").checked,
                buyer_social: document.getElementById("f_buyer_social").checked
            };

            // 禁用按鈕防止重複點擊
            const createBtn = document.getElementById("createBtn");
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> 建立中...';


            const res = await apiCreateForm(owner_id, owner_email, title, description, fields);

            if(res.success){
                alert("表單建立成功！現在將導向儀表板。");
                // 這裡也修正：確保跳轉 URL 被雙引號包圍
                location.href = "{{ url_for('dashboard_page') }}"; 
            } else {
                alert("建立失敗：" + (res.message || "未知錯誤"));
                createBtn.disabled = false; // 失敗後重新啟用按鈕
                createBtn.innerHTML = '<i class="fas fa-check me-1"></i> 建立表單';
            }
        });
    </script>

</body>
</html>