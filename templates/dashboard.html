<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„€è¡¨æ¿ | è¨‚å–®ç®¡ç†ç³»çµ±</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8uR2gII9oMvW14jWc//Y4/l86iM/8U8/51L6I6w1YtJ5P5w5/2F/1L6W1P5w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> 
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid container-xl">
            <a class="navbar-brand fw-bold" href="#">ğŸ›’ è¨‚å–®ç®¡ç†ç³»çµ±</a>
            
            <div class="d-flex align-items-center">
                <span class="navbar-text me-3 text-white">
                    <i class="fas fa-user-circle me-1"></i> æ‚¨å¥½ï¼Œ<span id="usernameDisplay"></span>
                </span>
                
                <button onclick="logout()" class="btn btn-outline-light btn-sm fw-bold">
                    <i class="fas fa-sign-out-alt me-1"></i> ç™»å‡º
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid container-xl mt-4">
        <h3 class="mb-4">ğŸ“‹ å„€è¡¨æ¿æ¦‚è¦½</h3>

        <div class="row g-4">
            <div class="col-lg-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h4 class="card-title mb-3">å¸³è™Ÿè¨­å®š</h4>
                        
                        <div id="displayNameArea" class="d-flex align-items-center mb-3">
                            <p class="mb-0 me-3 fw-bold">ç•¶å‰åç¨±: <span class="text-primary" id="currentUsernameDisplay"></span></p>
                            <button id="changeNameBtn" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-edit me-1"></i> æ›´æ”¹åç¨±
                            </button>
                        </div>

                        <div id="changeArea" class="input-group" style="display:none;">
                            <input id="newName" class="form-control" placeholder="è¼¸å…¥æ–°çš„ä½¿ç”¨è€…åç¨±">
                            <button id="saveName" class="btn btn-primary">å„²å­˜</button>
                            <button id="cancelName" class="btn btn-outline-danger">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i> æˆ‘çš„è¡¨å–® (è³£å®¶)</h5>
                        <button id="createFormBtn" class="btn btn-primary btn-sm fw-bold">
                            <i class="fas fa-plus me-1"></i> æ–°å¢è¡¨å–®
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <ul id="ownedList" class="list-group list-group-flush">
                            </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-eye me-2"></i> æˆ‘è¢«æˆæ¬Šçš„è¡¨å–® (è²·å®¶)</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul id="viewableList" class="list-group list-group-flush">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script src="{{ url_for('static', filename='api.js') }}"></script>

    <script>
        // ç¢ºä¿å‡½å¼å­˜åœ¨ï¼Œä»¥ä¾¿ Navbar ä¸­çš„æŒ‰éˆ•å¯ä»¥ä½¿ç”¨
        function logout(){
             if(confirm("ç¢ºå®šç™»å‡ºå—ï¼Ÿ")){
                localStorage.removeItem("user_id");
                localStorage.removeItem("username");
                location.href = "/login";
             }
        }
        
        const user_id = localStorage.getItem("user_id");
        const username = localStorage.getItem("username");
        const email = localStorage.getItem("email");
        
        // æ›´æ–° UI é¡¯ç¤º (Navbar å’Œ Card å…§)
        document.getElementById("usernameDisplay").innerText = username || "";
        document.getElementById("currentUsernameDisplay").innerText = username || "";

        // -----------------------------------------------------------
        // å¸³è™Ÿåç¨±ä¿®æ”¹é‚è¼¯ (ä¿ç•™ä¸¦å„ªåŒ–æ¨£å¼)
        // -----------------------------------------------------------
        document.getElementById("changeNameBtn").addEventListener("click", ()=>{
            document.getElementById("changeArea").style.display = "flex"; // ä½¿ç”¨ flex è®“ input å’Œ button æ’åˆ—
            document.getElementById("displayNameArea").style.display = "none";
            document.getElementById("newName").value = username || "";
        });
        document.getElementById("cancelName").addEventListener("click", ()=> {
            document.getElementById("changeArea").style.display="none";
            document.getElementById("displayNameArea").style.display="flex";
        });
        document.getElementById("saveName").addEventListener("click", async ()=>{
            const newName = document.getElementById("newName").value;
            if(!newName) return alert("è«‹è¼¸å…¥åç¨±");
            const res = await apiUpdateUsername(user_id, newName);
            if(res.success){
                localStorage.setItem("username", res.username);
                // åŒæ™‚æ›´æ–° Navbar å’Œ Card å…§çš„åç¨±
                document.getElementById("usernameDisplay").innerText = res.username;
                document.getElementById("currentUsernameDisplay").innerText = res.username; 
                document.getElementById("changeArea").style.display = "none";
                document.getElementById("displayNameArea").style.display="flex";
            } else alert("æ›´æ–°å¤±æ•—");
        });

        document.getElementById("createFormBtn").addEventListener("click", ()=> location.href="/create_form");

        // -----------------------------------------------------------
        // è¡¨å–®åˆ—è¡¨åŠ è¼‰é‚è¼¯ (ä½¿ç”¨ List Group æ¨£å¼å„ªåŒ–)
        // -----------------------------------------------------------
        async function load(){
            const data = await apiGetMyForms(user_id);
            const owned = data.owned || [];
            const viewable = data.viewable || [];
            const ownedList = document.getElementById("ownedList");
            const viewList = document.getElementById("viewableList");

            // è³£å®¶è¡¨å–®
            ownedList.innerHTML = "";
            if (owned.length === 0) {
                 ownedList.innerHTML = '<li class="list-group-item text-center text-muted">ç›®å‰æ²’æœ‰æ‚¨å»ºç«‹çš„è¡¨å–®ã€‚</li>';
            }
            owned.forEach(f=>{
                const li = document.createElement("li");
                // ä½¿ç”¨ list-group-item æ¨£å¼ï¼Œä¸¦ç”¨ flex ä½ˆå±€æŒ‰éˆ•
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
                    <div class="fw-bold me-3 text-truncate">${f.title}</div>
                    <div class="btn-group btn-group-sm flex-shrink-0" role="group">
                        <button onclick="openForm('${f._id}','owner')" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i> ç·¨è¼¯/æŸ¥çœ‹
                        </button>
                        <button onclick="manageViewers('${f._id}')" class="btn btn-outline-info">
                            <i class="fas fa-users-cog me-1"></i> ç®¡ç†æª¢è¦–è€…
                        </button>
                        <button onclick="deleteForm('${f._id}')" class="btn btn-outline-danger">
                            <i class="fas fa-trash-alt me-1"></i> åˆªé™¤
                        </button>
                    </div>
                `;
                ownedList.appendChild(li);
            });

            // è²·å®¶è¡¨å–®
            viewList.innerHTML = "";
            if (viewable.length === 0) {
                 viewList.innerHTML = '<li class="list-group-item text-center text-muted">ç›®å‰æ²’æœ‰æ‚¨å¯æŸ¥çœ‹çš„è¡¨å–®ã€‚</li>';
            }
            viewable.forEach(f=>{
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
                    <div class="fw-bold me-3 text-truncate">${f.title}</div>
                    <button onclick="openForm('${f._id}','viewer')" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-eye me-1"></i> æŸ¥çœ‹è¡¨å–®
                    </button>
                `;
                viewList.appendChild(li);
            });
        }

        // -----------------------------------------------------------
        // å»£åŸŸå‡½å¼ (Global Functions)
        // -----------------------------------------------------------
        window.openForm = function(fid, role){
            localStorage.setItem("form_id", fid);
            localStorage.setItem("form_role", role);
            location.href = "/form";
        }

        window.manageViewers = function(fid){
            const email = prompt("è¼¸å…¥è¦åŠ å…¥çš„ buyer çš„ Emailï¼ˆæ­¤ email å¿…é ˆå·²è¨»å†Šï¼‰");
            if(!email) return;
            apiAddViewer(fid, user_id, email).then(res=>{
                if(res.success) { alert("åŠ å…¥æˆåŠŸ"); load(); }
                else alert(res.message || "åŠ å…¥å¤±æ•—");
            });
        }

        window.deleteForm = function(fid){
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤è¡¨å–®ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å›å¾©")) return;
            fetch(`${API_BASE}/api/delete_form`, {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({form_id: fid, owner_id: user_id})
            }).then(r=>r.json()).then(res=>{
                if(res.success) load(); else alert("åˆªé™¤å¤±æ•—");
            }).catch(() => alert("åˆªé™¤å¤±æ•—ï¼šé€£ç·šéŒ¯èª¤"));
        }

        // åˆå§‹åŒ–
        load();
    </script>
</body>
</html>